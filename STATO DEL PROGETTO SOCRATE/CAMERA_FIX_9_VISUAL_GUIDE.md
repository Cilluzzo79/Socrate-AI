# Camera FIX 9 - Visual Guide

**Diagrams and Flowcharts for Understanding FIX 9**

---

## 1. Problem Visualization: Oppo Odd/Even Bug

### FIX 8 Behavior (BROKEN)

```
User Timeline                     Browser State                    Result
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T0: Click camera button
    â””â”€> Camera app opens          input.files = []                 âœ“ Ready

T1: User takes Photo 1 (ODD)
    Stays in camera app           input.files = []                 â³ Pending
                                  (Photo 1 in OS buffer)

T2: User takes Photo 2 (EVEN)
    Returns to browser            input.files = [Photo1]           ğŸ”¥ Race!
                                  (Photo 2 in OS buffer)

T3: change event fires
    processCameraFile() runs      Processing Photo 1...            âœ“ OK

T4: Processing completes
    cameraInput.value = ''        input.files = []                 âŒ LOST!
                                  (Photo 2 destroyed!)

T5: User takes Photo 3 (ODD)
    Stays in camera app           input.files = []                 â³ Pending
                                  (Photo 3 in OS buffer)

T6: User takes Photo 4 (EVEN)
    Returns to browser            input.files = [Photo3]           ğŸ”¥ Race!
                                  (Photo 4 in OS buffer)

T7: change event fires
    processCameraFile() runs      Processing Photo 3...            âœ“ OK

T8: Processing completes
    cameraInput.value = ''        input.files = []                 âŒ LOST!
                                  (Photo 4 destroyed!)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FINAL RESULT: Photos 1, 3 captured âœ…
              Photos 2, 4 LOST âŒ
              Success Rate: 50%
```

### FIX 9 Behavior (CORRECT)

```
User Timeline                     Browser State                    Tracker State           Result
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T0: Click camera button
    â””â”€> Camera app opens          input.files = []                 processed = {}          âœ“ Ready

T1: User takes Photo 1 (ODD)
    Stays in camera app           input.files = []                 processed = {}          â³ Pending
                                  (Photo 1 in OS buffer)

T2: User takes Photo 2 (EVEN)
    Returns to browser            input.files = [Photo1]           processed = {}          âœ… Ready
                                  (Photo 2 in OS buffer)

T3: change event fires
    processCameraFile() runs
    getNewFiles([Photo1])         Processing Photo 1...            processed = {}          âœ… Processing
    â†’ [Photo1] (new)

T4: Processing completes
    markProcessed(Photo1)         input.files = [Photo1]           processed = {           âœ… Captured
    âš ï¸ NO INPUT RESET              (Photo 2 in OS buffer)           Photo1: {...}          Photo 1
                                                                  }                       â³ Photo 2 pending

T5: User takes Photo 3 (ODD)
    Stays in camera app           input.files = [Photo1]           processed = {           â³ Pending
                                  (Photo 2, 3 in OS buffer)        Photo1: {...}
                                                                  }

T6: User takes Photo 4 (EVEN)
    Returns to browser            input.files = [Photo1,           processed = {           âœ… Ready
                                                Photo2,            Photo1: {...}
                                                Photo3]            }
                                  (Photo 4 in OS buffer)

T7: change event fires
    processCameraFile() runs
    getNewFiles([P1, P2, P3])     Processing Photo 2, 3...         processed = {           âœ… Processing
    â†’ [Photo2, Photo3]                                             Photo1: {...}
    (Photo1 filtered)                                              }

T8: Processing completes
    markProcessed(Photo2, 3)      input.files = [P1, P2, P3]       processed = {           âœ… Captured
    âš ï¸ NO INPUT RESET              (Photo 4 in OS buffer)           Photo1: {...},         Photos 1-3
                                                                    Photo2: {...},         â³ Photo 4 pending
                                                                    Photo3: {...}
                                                                  }

T9: User clicks "Upload"
    uploadBatch() SUCCESS         input.files = []                 processed = {}          âœ… Session
    cleanupCameraSession()        (NOW safe to reset)              (tracker reset)        complete
                                                                                          All 4 photos
                                                                                          uploaded âœ…

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FINAL RESULT: Photos 1, 2, 3, 4 ALL captured âœ…
              Photos LOST: 0 âŒ
              Success Rate: 100%
```

---

## 2. Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FIX 9 CAMERA SYSTEM DATA FLOW                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Action  â”‚
â”‚ (Camera)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Takes photo(s)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OS Camera App                          â”‚
â”‚ - Buffers photos in memory             â”‚
â”‚ - Returns to browser when user exits   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ On focus return
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser FileInput                                            â”‚
â”‚ <input type="file" accept="image/*" capture="environment">  â”‚
â”‚ input.files = FileList [Photo1, Photo2, ...]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ change/input event
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ processCameraFile()                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ 1. Get files from input                                  â”‚â”‚
â”‚ â”‚    const files = Array.from(cameraInput.files)           â”‚â”‚
â”‚ â”‚                                                           â”‚â”‚
â”‚ â”‚ 2. Filter NEW files (deduplication)                      â”‚â”‚
â”‚ â”‚    const newFiles = cameraFileTracker.getNewFiles(files) â”‚â”‚
â”‚ â”‚                                                           â”‚â”‚
â”‚ â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚â”‚
â”‚ â”‚    â”‚ CameraFileTracker                      â”‚            â”‚â”‚
â”‚ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚            â”‚â”‚
â”‚ â”‚    â”‚ Map<fileKey, {imageId, timestamp}>     â”‚            â”‚â”‚
â”‚ â”‚    â”‚                                         â”‚            â”‚â”‚
â”‚ â”‚    â”‚ getFileKey(file):                      â”‚            â”‚â”‚
â”‚ â”‚    â”‚   "name::size::lastModified"           â”‚            â”‚â”‚
â”‚ â”‚    â”‚                                         â”‚            â”‚â”‚
â”‚ â”‚    â”‚ isProcessed(file):                     â”‚            â”‚â”‚
â”‚ â”‚    â”‚   return Map.has(fileKey)              â”‚            â”‚â”‚
â”‚ â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚â”‚
â”‚ â”‚                                                           â”‚â”‚
â”‚ â”‚ 3. Process ONLY new files in parallel                    â”‚â”‚
â”‚ â”‚    await Promise.allSettled(                             â”‚â”‚
â”‚ â”‚      newFiles.map(file => handleCameraCaptureAsync(file))â”‚â”‚
â”‚ â”‚    )                                                      â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ For each file
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ handleCameraCaptureAsync(file)                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ 1. Validate file (type, size)                            â”‚â”‚
â”‚ â”‚                                                           â”‚â”‚
â”‚ â”‚ 2. Create Blob URL (memory-efficient)                    â”‚â”‚
â”‚ â”‚    const blobUrl = URL.createObjectURL(file)             â”‚â”‚
â”‚ â”‚                                                           â”‚â”‚
â”‚ â”‚ 3. Validate image (decodable, non-corrupt)               â”‚â”‚
â”‚ â”‚    await validateImageUrl(blobUrl)                       â”‚â”‚
â”‚ â”‚                                                           â”‚â”‚
â”‚ â”‚ 4. Generate unique image ID                              â”‚â”‚
â”‚ â”‚    const imageId = `img-${Date.now()}-${random()}`       â”‚â”‚
â”‚ â”‚                                                           â”‚â”‚
â”‚ â”‚ 5. Add to captured images                                â”‚â”‚
â”‚ â”‚    capturedImages.push({id, file, blobUrl, timestamp})   â”‚â”‚
â”‚ â”‚                                                           â”‚â”‚
â”‚ â”‚ 6. Return imageId (for tracker)                          â”‚â”‚
â”‚ â”‚    return imageId                                        â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Returns imageId
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ processCameraFile() (continued)                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ 4. Mark successful files as processed                    â”‚â”‚
â”‚ â”‚    successful.forEach((result, index) => {               â”‚â”‚
â”‚ â”‚      const imageId = result.value                        â”‚â”‚
â”‚ â”‚      cameraFileTracker.markProcessed(newFiles[index],    â”‚â”‚
â”‚ â”‚                                       imageId)            â”‚â”‚
â”‚ â”‚    })                                                     â”‚â”‚
â”‚ â”‚                                                           â”‚â”‚
â”‚ â”‚ 5. âš ï¸ CRITICAL: Do NOT reset input                       â”‚â”‚
â”‚ â”‚    (Preserves buffered photos in OS memory)              â”‚â”‚
â”‚ â”‚                                                           â”‚â”‚
â”‚ â”‚ 6. Show preview modal                                    â”‚â”‚
â”‚ â”‚    showBatchPreview()                                    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ showBatchPreview()                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Display modal with:                                      â”‚â”‚
â”‚ â”‚ - Gallery of all captured images (thumbnails)            â”‚â”‚
â”‚ â”‚ - Document name input                                    â”‚â”‚
â”‚ â”‚ - Action buttons:                                        â”‚â”‚
â”‚ â”‚   [ğŸ“· Add Another Photo] [âŒ Cancel] [â˜ï¸ Upload]         â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ User chooses action
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â”‚                 â”‚
         â–¼                        â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Add Another     â”‚    â”‚ Cancel Batch     â”‚  â”‚ Upload Batch  â”‚
â”‚ Photo           â”‚    â”‚                  â”‚  â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚                    â”‚
         â”‚                      â”‚                    â”‚
         â”‚ openCamera()         â”‚ cleanupCamera      â”‚ uploadBatch()
         â”‚ (session continues)  â”‚ Session()          â”‚
         â”‚                      â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                    â”‚
                    â”‚           â”‚                    â”‚
                    â–¼           â–¼                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Back to camera             â”‚   â”‚ Upload to server â”‚
         â”‚ (tracker persists)         â”‚   â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â”‚ On success
                                                    â”‚
                                                    â–¼
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ cleanupCameraSession() â”‚
                                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
                                         â”‚ 1. Revoke Blob URLs    â”‚
                                         â”‚ 2. Clear capturedImagesâ”‚
                                         â”‚ 3. tracker.reset()     â”‚
                                         â”‚ 4. input.value = ''    â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. State Machine Visualization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FIX 9 CAMERA STATE MACHINE                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚        [IDLE]               â”‚
                    â”‚  capturedImages = []        â”‚
                    â”‚  tracker.processed = {}     â”‚
                    â”‚  input.value = ''           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ window.openCamera()
                               â”‚ â†’ cameraInput.click()
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    [CAMERA_OPEN]            â”‚
                    â”‚  OS camera app opens        â”‚
                    â”‚  User can take photos       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ User takes photo(s)
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     [CAPTURING]             â”‚
                    â”‚  Photos buffered in OS      â”‚
                    â”‚  Waiting for user to return â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ User returns to browser
                               â”‚ â†’ change/input event fires
                               â”‚ (or polling detects files)
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”‚    [PROCESSING]             â”‚
          â”‚        â”‚  isProcessing = true        â”‚
          â”‚        â”‚  getNewFiles() filters      â”‚
          â”‚        â”‚  handleCameraCaptureAsync() â”‚
          â”‚        â”‚  markProcessed()            â”‚
          â”‚        â”‚  input NOT reset âš ï¸         â”‚
          â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                   â”‚
          â”‚                   â”‚ Processing complete
          â”‚                   â”‚ isProcessing = false
          â”‚                   â”‚
          â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚        â”‚                                    â”‚
          â”‚        â”‚ More photos buffered?              â”‚
          â”‚        â”‚ (User took another while           â”‚
          â”‚        â”‚  processing was happening)         â”‚
          â”‚        â”‚                                    â”‚
          â”‚        â”‚ YES                     NO         â”‚
          â”‚        â”‚                                    â”‚
          â”‚        â–¼                         â–¼          â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
          â”‚  â”‚ change   â”‚        â”‚     [PREVIEWING]           â”‚
          â”‚  â”‚ event    â”‚        â”‚  Modal shows gallery       â”‚
          â”‚  â”‚ fires    â”‚        â”‚  User can:                 â”‚
          â”‚  â”‚ again    â”‚        â”‚  - Add Another Photo       â”‚
          â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚  - Cancel Batch            â”‚
          â”‚       â”‚              â”‚  - Upload Batch            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                          â”‚                       â”‚
                    â”‚                          â”‚                       â”‚
                    â–¼                          â–¼                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ [ADD ANOTHER     â”‚      â”‚ [CANCEL BATCH]    â”‚   â”‚ [UPLOAD BATCH]      â”‚
         â”‚  PHOTO]          â”‚      â”‚                   â”‚   â”‚                     â”‚
         â”‚                  â”‚      â”‚ Confirm dialog    â”‚   â”‚ FormData upload     â”‚
         â”‚ Modal closes     â”‚      â”‚ â†“                 â”‚   â”‚ â†“                   â”‚
         â”‚ openCamera()     â”‚      â”‚ YES               â”‚   â”‚ SUCCESS             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                          â”‚                        â”‚
                  â”‚                          â”‚                        â”‚
                  â”‚ Session                  â”‚ Session                â”‚ Session
                  â”‚ continues                â”‚ ends                   â”‚ ends
                  â”‚                          â”‚                        â”‚
                  â–¼                          â–¼                        â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ [CAMERA_OPEN]   â”‚      â”‚ cleanupCamera      â”‚   â”‚ cleanupCamera      â”‚
         â”‚ (loop back)     â”‚      â”‚ Session()          â”‚   â”‚ Session()          â”‚
         â”‚                 â”‚      â”‚ â†“                  â”‚   â”‚ â†“                  â”‚
         â”‚ Tracker         â”‚      â”‚ tracker.reset()    â”‚   â”‚ tracker.reset()    â”‚
         â”‚ persists        â”‚      â”‚ input.value = ''   â”‚   â”‚ input.value = ''   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ capturedImages=[]  â”‚   â”‚ capturedImages=[]  â”‚
                                  â”‚ â†“                  â”‚   â”‚ â†“                  â”‚
                                  â”‚ [IDLE]             â”‚   â”‚ [IDLE]             â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
State Invariants:
  - Input is NEVER reset while state âˆˆ {CAMERA_OPEN, CAPTURING, PROCESSING, PREVIEWING}
  - Input is ONLY reset when transitioning to [IDLE]
  - Tracker persists across CAMERA_OPEN â†’ PROCESSING loops (multi-photo capture)
  - Blob URLs are only revoked in cleanupCameraSession() (transition to IDLE)
```

---

## 4. Memory Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FIX 9 MEMORY ARCHITECTURE                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JavaScript Heap                                                    â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ cameraInput.files (FileList)                                 â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  [0] File {                                                  â”‚ â”‚
â”‚  â”‚        name: "IMG_1234.jpg",                                 â”‚ â”‚
â”‚  â”‚        size: 2097152,  // 2MB                                â”‚ â”‚
â”‚  â”‚        lastModified: 1729584000000,                          â”‚ â”‚
â”‚  â”‚        type: "image/jpeg",                                   â”‚ â”‚
â”‚  â”‚        âš ï¸ Blob data: ~2MB in memory                          â”‚ â”‚
â”‚  â”‚      }                                                        â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  [1] File { ... }  // ~2MB                                   â”‚ â”‚
â”‚  â”‚  [2] File { ... }  // ~2MB                                   â”‚ â”‚
â”‚  â”‚  ...                                                          â”‚ â”‚
â”‚  â”‚  [19] File { ... } // ~2MB                                   â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  Total: 20 files Ã— 2MB = ~40MB                               â”‚ â”‚
â”‚  â”‚  Lifecycle: Until cameraInput.value = '' in cleanup          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ capturedImages (Array)                                       â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  [                                                            â”‚ â”‚
â”‚  â”‚    {                                                          â”‚ â”‚
â”‚  â”‚      id: "img-1729584000000-abc123",      // ~50 bytes       â”‚ â”‚
â”‚  â”‚      file: File { ... },                  // Reference only  â”‚ â”‚
â”‚  â”‚      blobUrl: "blob:http://.../abc123",   // ~100 bytes      â”‚ â”‚
â”‚  â”‚      timestamp: 1729584000000             // 8 bytes         â”‚ â”‚
â”‚  â”‚    },                                                         â”‚ â”‚
â”‚  â”‚    { ... },                                                   â”‚ â”‚
â”‚  â”‚    { ... },                                                   â”‚ â”‚
â”‚  â”‚    ...                                                        â”‚ â”‚
â”‚  â”‚  ]                                                            â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  Total: 20 images Ã— ~160 bytes = ~3.2KB                      â”‚ â”‚
â”‚  â”‚  Lifecycle: Until capturedImages = [] in cleanup             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ cameraFileTracker.processedFiles (Map)                       â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  Map {                                                        â”‚ â”‚
â”‚  â”‚    "IMG_1234.jpg::2097152::1729584000000" => {               â”‚ â”‚
â”‚  â”‚      imageId: "img-1729584000000-abc123",  // ~50 bytes      â”‚ â”‚
â”‚  â”‚      timestamp: 1729584000000,             // 8 bytes        â”‚ â”‚
â”‚  â”‚      fileName: "IMG_1234.jpg"              // ~20 bytes      â”‚ â”‚
â”‚  â”‚    },                                                         â”‚ â”‚
â”‚  â”‚    "IMG_1235.jpg::2097152::1729584001000" => { ... },        â”‚ â”‚
â”‚  â”‚    ...                                                        â”‚ â”‚
â”‚  â”‚  }                                                            â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  Total: 20 entries Ã— ~200 bytes = ~4KB                       â”‚ â”‚
â”‚  â”‚  Lifecycle: Until tracker.reset() in cleanup                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser Blob Storage (Separate from JS Heap)                      â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Blob URLs (Managed by browser)                               â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  blob:http://localhost:5000/abc123 â†’ File { ... } (2MB)      â”‚ â”‚
â”‚  â”‚  blob:http://localhost:5000/def456 â†’ File { ... } (2MB)      â”‚ â”‚
â”‚  â”‚  blob:http://localhost:5000/ghi789 â†’ File { ... } (2MB)      â”‚ â”‚
â”‚  â”‚  ...                                                          â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  Total: 20 Blob URLs referencing 40MB of file data           â”‚ â”‚
â”‚  â”‚  (File data is SAME as cameraInput.files, not duplicated)    â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  Lifecycle: Until URL.revokeObjectURL() in cleanup           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TOTAL MEMORY USAGE (20 photos):
  File data (input.files):       40MB  (99.9%)
  Blob URLs (references only):   <1KB  (0.0%)
  capturedImages metadata:       3.2KB (0.0%)
  Tracker metadata:              4KB   (0.0%)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  TOTAL:                         ~40MB (100%)

FIX 9 Overhead: 7.2KB / 40MB = 0.018% (negligible)
```

---

## 5. Deduplication Algorithm

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               FIX 9 DEDUPLICATION ALGORITHM                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Input: cameraInput.files = FileList [File1, File2, File3, File1 (duplicate)]
                                      â†“
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ getNewFiles(fileList)  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Convert to array               â”‚
                    â”‚ files = Array.from(fileList)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Filter with deduplication      â”‚
                    â”‚ files.filter(f => {            â”‚
                    â”‚   return !isProcessed(f)       â”‚
                    â”‚ })                              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ For each file
                               â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                  â”‚                  â”‚             â”‚
            â–¼                  â–¼                  â–¼             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”
        â”‚ File1 â”‚          â”‚ File2 â”‚         â”‚ File3 â”‚     â”‚ File1 â”‚
        â””â”€â”€â”€â”¬â”€â”€â”€â”˜          â””â”€â”€â”€â”¬â”€â”€â”€â”˜         â””â”€â”€â”€â”¬â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”˜
            â”‚                  â”‚                 â”‚             â”‚
            â–¼                  â–¼                 â–¼             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ getFileKey(file)                                      â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
        â”‚ return `${file.name}::${file.size}::${file.lastModified}` â”‚
        â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
            â”‚               â”‚               â”‚               â”‚
            â–¼               â–¼               â–¼               â–¼
        "IMG_1234.jpg     "IMG_1235.jpg   "IMG_1236.jpg   "IMG_1234.jpg
         ::2097152         ::2097152       ::2097152       ::2097152
         ::1729584000000"  ::1729584001000"::1729584002000"::1729584000000"
                                                           (DUPLICATE KEY!)
            â”‚               â”‚               â”‚               â”‚
            â–¼               â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ processedFiles.has(key)                              â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
        â”‚ Check if key exists in Map                           â”‚
        â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
            â”‚               â”‚               â”‚               â”‚
            â–¼               â–¼               â–¼               â–¼
        false           false           false           true (if File1
        (NEW)           (NEW)           (NEW)           was processed)
            â”‚               â”‚               â”‚               â”‚
            â–¼               â–¼               â–¼               â–¼
        INCLUDE         INCLUDE         INCLUDE         EXCLUDE
            â”‚               â”‚               â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ newFiles =    â”‚
                    â”‚ [File1,       â”‚
                    â”‚  File2,       â”‚
                    â”‚  File3]       â”‚
                    â”‚               â”‚
                    â”‚ (File1 dup    â”‚
                    â”‚  filtered     â”‚
                    â”‚  out)         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
KEY INSIGHT: File.lastModified is CRITICAL
  - Same filename + size can occur if user deletes and retakes photo
  - lastModified timestamp changes each time camera captures
  - Ensures unique key for each physical photo

EXAMPLE:
  User takes IMG_1234.jpg â†’ 1729584000000
  User deletes photo in camera app
  User takes new IMG_1234.jpg â†’ 1729584120000

  Keys are different:
    "IMG_1234.jpg::2097152::1729584000000" (old)
    "IMG_1234.jpg::2097152::1729584120000" (new)

  Both photos processed correctly âœ…
```

---

## 6. Session Lifecycle Timeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FIX 9 SESSION LIFECYCLE TIMELINE                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Time   Event                           State Changes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0     User clicks "ğŸ“· Camera" button
       â””â”€> window.openCamera()          capturedImages = []
                                        tracker.processedFiles = {}
                                        input.value = ''
                                        State: [IDLE] â†’ [CAMERA_OPEN]

T1     Camera app opens
       User sees camera viewfinder      State: [CAMERA_OPEN]

T2     User takes Photo 1
       â””â”€> OS buffers photo             State: [CAMERA_OPEN] â†’ [CAPTURING]

T3     User returns to browser
       â””â”€> change event fires            State: [CAPTURING] â†’ [PROCESSING]
           input.files = [Photo1]

T4     processCameraFile() executes
       â”œâ”€> getNewFiles([Photo1])        newFiles = [Photo1] (all new)
       â”‚   â†’ [Photo1] (new)
       â”‚
       â”œâ”€> handleCameraCaptureAsync()   capturedImages = [
       â”‚                                  {id: "img-1", file: Photo1, ...}
       â”‚                                ]
       â”‚
       â”œâ”€> markProcessed(Photo1)        tracker.processedFiles = {
       â”‚                                  "Photo1-key": {...}
       â”‚                                }
       â”‚
       â””â”€> showBatchPreview()           State: [PROCESSING] â†’ [PREVIEWING]
           âš ï¸ input NOT reset!           input.files = [Photo1] (preserved)

T5     Modal shows 1 photo
       User clicks "ğŸ“· Add Another"
       â””â”€> addAnotherPhoto()            State: [PREVIEWING] â†’ [CAMERA_OPEN]
           Modal closes                 (session continues, tracker persists)

T6     Camera reopens
       User takes Photo 2               State: [CAMERA_OPEN] â†’ [CAPTURING]

T7     User returns to browser
       â””â”€> change event fires            State: [CAPTURING] â†’ [PROCESSING]
           input.files = [Photo1,        (Photo1 still in input!)
                          Photo2]

T8     processCameraFile() executes
       â”œâ”€> getNewFiles([P1, P2])        newFiles = [Photo2] (P1 filtered)
       â”‚   â†’ [Photo2] (P1 skipped)      console: "Filtered 1 duplicate file(s)"
       â”‚
       â”œâ”€> handleCameraCaptureAsync()   capturedImages = [
       â”‚                                  {id: "img-1", file: Photo1, ...},
       â”‚                                  {id: "img-2", file: Photo2, ...}
       â”‚                                ]
       â”‚
       â”œâ”€> markProcessed(Photo2)        tracker.processedFiles = {
       â”‚                                  "Photo1-key": {...},
       â”‚                                  "Photo2-key": {...}
       â”‚                                }
       â”‚
       â””â”€> showBatchPreview()           State: [PROCESSING] â†’ [PREVIEWING]
           âš ï¸ input NOT reset!           input.files = [P1, P2] (preserved)

T9     Modal shows 2 photos
       User enters document name
       User clicks "â˜ï¸ Upload"
       â””â”€> uploadBatch()                State: [PREVIEWING] â†’ [UPLOADING]

T10    FormData created
       â”œâ”€> files appended to FormData   FormData: [Photo1, Photo2]
       â””â”€> POST /api/upload/batch       Network request sent

T11    Server responds 200 OK
       â””â”€> Upload SUCCESS               State: [UPLOADING] â†’ [CLEANUP]

T12    cleanupCameraSession() executes
       â”œâ”€> Revoke Blob URLs             URL.revokeObjectURL(img-1.blobUrl)
       â”‚                                URL.revokeObjectURL(img-2.blobUrl)
       â”‚
       â”œâ”€> Clear images                 capturedImages = []
       â”‚
       â”œâ”€> Reset tracker                tracker.processedFiles = {}
       â”‚                                tracker.sessionStartTime = now
       â”‚
       â””â”€> Reset input                  input.value = ''
                                        input.files = []

T13    Modal closes
       â””â”€> closePreviewModal()          State: [CLEANUP] â†’ [IDLE]

T14    Success message shown
       Document list refreshed          Ready for next session âœ…

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total session time: ~60 seconds (typical)
Photos captured: 2/2 (100% success rate)
Memory leaked: 0 bytes (all Blob URLs revoked)
```

---

**Document Version**: 1.0
**Last Updated**: 2025-10-21
**Author**: Frontend Architect Prime
