<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Socrate AI</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="icon" type="image/svg+xml" href="/static/images/logo-icon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard">
        <!-- Dashboard Header -->
        <header class="dashboard-header">
            <div class="dashboard-header-content">
                <!-- Logo Hero Section -->
                <a href="/" class="dashboard-logo-hero">
                    <div class="logo-owl-container">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120" class="logo-owl-icon" role="img" aria-label="Socrate AI Owl">
                            <defs>
                                <linearGradient id="owlCyanGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#00FFE0;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#00D9C0;stop-opacity:1" />
                                </linearGradient>
                                <linearGradient id="owlBronzeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#D4AF37;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#C9A971;stop-opacity:1" />
                                </linearGradient>
                                <filter id="owlGlow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                                    <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                                </filter>
                                <filter id="owlStrongGlow" x="-100%" y="-100%" width="300%" height="300%">
                                    <feGaussianBlur stdDeviation="6" result="coloredBlur"/>
                                    <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                                </filter>
                            </defs>
                            <circle cx="60" cy="60" r="50" fill="none" stroke="url(#owlCyanGrad)" stroke-width="2.5" filter="url(#owlGlow)" opacity="0.8"/>
                            <ellipse cx="60" cy="65" rx="22" ry="28" fill="url(#owlBronzeGrad)"/>
                            <circle cx="60" cy="45" r="18" fill="url(#owlBronzeGrad)"/>
                            <circle cx="54" cy="43" r="5" fill="#00FFE0" filter="url(#owlStrongGlow)"/>
                            <circle cx="66" cy="43" r="5" fill="#00FFE0" filter="url(#owlStrongGlow)"/>
                            <circle cx="54" cy="43" r="2" fill="#0f1319"/>
                            <circle cx="66" cy="43" r="2" fill="#0f1319"/>
                            <path d="M 60 48 L 58 52 L 62 52 Z" fill="#D4AF37"/>
                            <path d="M 48 35 L 50 30 L 52 35" stroke="url(#owlBronzeGrad)" stroke-width="1.5" fill="none"/>
                            <path d="M 68 35 L 70 30 L 72 35" stroke="url(#owlBronzeGrad)" stroke-width="1.5" fill="none"/>
                            <g opacity="0.95">
                                <path d="M 82 60 Q 95 50, 105 55 Q 110 60, 105 70 Q 95 75, 82 68 Z" fill="none" stroke="url(#owlCyanGrad)" stroke-width="2" filter="url(#owlGlow)"/>
                                <line x1="85" y1="58" x2="95" y2="58" stroke="#00D9C0" stroke-width="1.5" opacity="0.8"/>
                                <line x1="95" y1="58" x2="95" y2="65" stroke="#00D9C0" stroke-width="1.5" opacity="0.8"/>
                                <line x1="88" y1="65" x2="98" y2="65" stroke="#00D9C0" stroke-width="1.5" opacity="0.8"/>
                                <circle cx="85" cy="58" r="2" fill="#00FFE0" filter="url(#owlStrongGlow)"/>
                                <circle cx="95" cy="58" r="2" fill="#00FFE0" filter="url(#owlStrongGlow)"/>
                                <circle cx="95" cy="65" r="2" fill="#00FFE0" filter="url(#owlStrongGlow)"/>
                                <circle cx="88" cy="65" r="2" fill="#00FFE0" filter="url(#owlStrongGlow)"/>
                                <polygon points="100,62 102,60 104,62 102,64" fill="none" stroke="#00D9C0" stroke-width="1" opacity="0.7"/>
                            </g>
                            <path d="M 38 60 Q 25 50, 15 55 Q 10 60, 15 70 Q 25 75, 38 68 Z" fill="url(#owlBronzeGrad)" opacity="0.7"/>
                            <path d="M 54 88 L 52 92 M 54 88 L 56 92" stroke="url(#owlBronzeGrad)" stroke-width="2" stroke-linecap="round"/>
                            <path d="M 66 88 L 64 92 M 66 88 L 68 92" stroke="url(#owlBronzeGrad)" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="logo-text-container">
                        <span class="logo-brand">SOCRATE</span>
                        <span class="logo-ai">AI</span>
                        <span class="logo-tagline">Knowledge Assistant</span>
                    </div>
                </a>

                <!-- Actions Section -->
                <div class="dashboard-actions">
                    <button class="btn btn-tools" onclick="toggleToolsMenu()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 15l-3-3h6l-3 3zm0-6l3 3H9l3-3z"/>
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        <span>Strumenti</span>
                    </button>

                    <div class="dashboard-user">
                        <div class="user-info">
                            <img src="{{ user.photo_url or 'https://via.placeholder.com/40' }}"
                                 alt="{{ user.first_name }}"
                                 class="user-avatar">
                            <div>
                                <div class="user-name">{{ user.first_name }} {{ user.last_name or '' }}</div>
                                <span class="badge badge-gold">{{ user.subscription_tier }}</span>
                            </div>
                        </div>
                        <a href="/logout" class="btn btn-ghost btn-sm">Logout</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Main Content -->
        <main class="dashboard-main">
            <!-- Welcome Message -->
            <div class="dashboard-welcome">
                <h1>Bentornato, {{ user.first_name }}! <span style="color: var(--color-accent-gold);">üëã</span></h1>
                <p>Gestisci i tuoi documenti, carica nuovi contenuti e interroga la tua knowledge base.</p>
            </div>

            <!-- Stats Row -->
            <div class="stats-row">
                <div class="stat-widget">
                    <div class="stat-widget-header">
                        <div class="stat-widget-icon">üìÅ</div>
                    </div>
                    <div class="stat-widget-value">{{ stats.documents.total }}</div>
                    <div class="stat-widget-label">Documenti Totali</div>
                </div>

                <div class="stat-widget stat-widget-bronze">
                    <div class="stat-widget-header">
                        <div class="stat-widget-icon">‚úÖ</div>
                    </div>
                    <div class="stat-widget-value">{{ stats.documents.ready }}</div>
                    <div class="stat-widget-label">Pronti</div>
                </div>

                <div class="stat-widget">
                    <div class="stat-widget-header">
                        <div class="stat-widget-icon">‚öôÔ∏è</div>
                    </div>
                    <div class="stat-widget-value">{{ stats.documents.processing }}</div>
                    <div class="stat-widget-label">In Elaborazione</div>
                </div>

                <div class="stat-widget stat-widget-bronze">
                    <div class="stat-widget-header">
                        <div class="stat-widget-icon">üí¨</div>
                    </div>
                    <div class="stat-widget-value">{{ stats.chat_sessions.total }}</div>
                    <div class="stat-widget-label">Chat Totali</div>
                </div>
            </div>

            <!-- Storage Info Card -->
            <div class="card card-glow" style="margin-bottom: var(--space-8);">
                <div class="card-header">
                    <h3 class="card-title">üíæ Spazio di Archiviazione</h3>
                    <p class="card-subtitle">
                        {{ user.storage_used_mb | round(2) }} MB / {{ user.storage_quota_mb }} MB utilizzati
                    </p>
                </div>
                <div class="upload-progress-bar">
                    <div class="upload-progress-fill"
                         style="width: {{ (user.storage_used_mb / user.storage_quota_mb * 100) | round }}%">
                    </div>
                </div>
            </div>

            <!-- Upload Section -->
            <section class="upload-section">
                <div class="section-header">
                    <h2 class="section-title">üì§ Carica Nuovo Documento</h2>
                </div>

                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">üìÑ</div>
                    <div class="upload-text">Trascina un file qui o clicca per selezionare</div>
                    <div class="upload-hint">Supportati: PDF, DOCX, TXT, JPG, PNG, HEIC, WebP, TIFF (max {{ user.storage_quota_mb - user.storage_used_mb | round(2) }} MB disponibili)</div>
                    <input type="file" id="file-input" accept=".pdf,.docx,.txt,.jpg,.jpeg,.png,.heic,.heif,.webp,.bmp,.tiff" style="display: none;">
                </div>

                <div id="upload-progress-container" class="upload-progress" style="display: none;">
                    <div class="upload-progress-bar">
                        <div class="upload-progress-fill" id="upload-progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="upload-progress-text" id="upload-progress-text">Caricamento...</div>
                </div>
            </section>

            <!-- Documents Section -->
            <section class="documents-section">
                <div class="section-header">
                    <h2 class="section-title">üìö I Miei Documenti</h2>
                </div>

                <div class="documents-controls">
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text"
                               id="search-input"
                               placeholder="Cerca documenti per nome..."
                               aria-label="Cerca documenti">
                    </div>
                    <button class="btn btn-outline" onclick="loadDocuments()">
                        <span>üîÑ</span>
                        <span>Aggiorna</span>
                    </button>
                </div>

                <!-- Documents Grid -->
                <div id="documents-grid" class="documents-grid">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üì≠</div>
                    <h3 class="empty-state-title">Nessun documento caricato</h3>
                    <p class="empty-state-text">
                        Carica il tuo primo documento per iniziare a usare Socrate AI
                    </p>
                    <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                        <span>üì§</span>
                        <span>Carica Documento</span>
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal" style="display: none;">
        <div class="modal-content" style="background: var(--color-bg-card); border: 1px solid var(--color-border-subtle); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 500px;">
            <h2 style="color: var(--color-text-primary); margin-bottom: var(--space-4);">‚ö†Ô∏è Conferma Eliminazione</h2>
            <p style="color: var(--color-text-secondary); margin-bottom: var(--space-6);">
                Sei sicuro di voler eliminare questo documento? Questa azione non pu√≤ essere annullata.
            </p>
            <div style="display: flex; gap: var(--space-3);">
                <button class="btn btn-secondary" onclick="closeDeleteModal()" style="flex: 1;">Annulla</button>
                <button class="btn btn-primary" onclick="confirmDelete()" style="flex: 1; background: var(--color-error);">Elimina</button>
            </div>
        </div>
    </div>

    <script src="/static/js/dashboard.js"></script>
    <script>
        let documentToDelete = null;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadDocuments();
            setupUploadHandlers();
        });

        // Setup drag & drop upload
        function setupUploadHandlers() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');

            // Click to upload
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // Drag & drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragging');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragging');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragging');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }

        // Handle file upload
        async function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);

            const progressContainer = document.getElementById('upload-progress-container');
            const progressFill = document.getElementById('upload-progress-fill');
            const progressText = document.getElementById('upload-progress-text');

            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Caricamento...';

            try {
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressFill.style.width = percentComplete + '%';
                        progressText.textContent = `Caricamento: ${Math.round(percentComplete)}%`;
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        progressText.textContent = '‚úÖ Caricamento completato! Il documento √® in elaborazione...';
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            document.getElementById('file-input').value = '';
                            loadDocuments();
                        }, 2000);
                    } else {
                        progressText.textContent = '‚ùå Errore durante il caricamento';
                        console.error('Upload failed:', xhr.responseText);
                    }
                });

                xhr.addEventListener('error', () => {
                    progressText.textContent = '‚ùå Errore di rete';
                });

                xhr.open('POST', '/api/documents/upload');
                xhr.send(formData);

            } catch (error) {
                console.error('Upload error:', error);
                progressText.textContent = '‚ùå Errore durante il caricamento';
            }
        }

        // Delete modal functions
        function openDeleteModal(documentId) {
            documentToDelete = documentId;
            document.getElementById('delete-modal').style.display = 'flex';
        }

        function closeDeleteModal() {
            documentToDelete = null;
            document.getElementById('delete-modal').style.display = 'none';
        }

        async function confirmDelete() {
            if (!documentToDelete) return;

            try {
                const response = await fetch(`/api/documents/${documentToDelete}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    closeDeleteModal();
                    loadDocuments();
                } else {
                    alert('Errore durante l\'eliminazione del documento');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Errore durante l\'eliminazione del documento');
            }
        }

        // Search functionality
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const documentCards = document.querySelectorAll('.document-card');

            documentCards.forEach(card => {
                const title = card.querySelector('.document-title').textContent.toLowerCase();
                if (title.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // Tools menu placeholder (per futuro sviluppo)
        function toggleToolsMenu() {
            // TODO: Implementare menu strumenti con opzioni:
            // - Genera quiz
            // - Riassunto
            // - Mind map
            // - Outline
            // - Analisi avanzata
            alert('Menu Strumenti in arrivo! Include: Quiz, Riassunti, Mind Maps, Outline e molto altro.');
        }
    </script>
</body>
</html>
